<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="你好，我是米歐，歡迎來到我的部落格:)"><meta property="og:title" content="MMiooiMM"><meta property="og:description" content="你好，我是米歐，歡迎來到我的部落格:)"><meta property="og:image" content="https://raw.githubusercontent.com/MMiooiMM/MMiooiMM.github.io/master/images/VeryImportantFile.jpg"><title>.NET 後端起手式 30天認識 C# - Day 26 反射 | MMiooiMM</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="/css/mio.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 4.2.1"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/2019-iT-%E9%82%A6%E5%B9%AB%E5%BF%99%E9%90%B5%E4%BA%BA%E8%B3%BD/" rel="tag">2019 iT 邦幫忙鐵人賽</a><a class="post-tag-link" href="/tags/CSharp/" rel="tag">CSharp</a></div><div class="post-time">2018-11-05</div></div></div><div class="container post-header"><h1>.NET 後端起手式 30天認識 C# - Day 26 反射</h1></div><div class="container post-content"><h2 id="DAY-26-反射"><a href="#DAY-26-反射" class="headerlink" title="DAY 26 反射"></a>DAY 26 反射</h2><h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><blockquote>
<p>System.Reflection 命名空間中的類別，連同 System.Type，可讓您取得已載入組件和其中所定義類型的資訊，例如類別、介面和實值型別。<br>您也可以使用反映在執行階段建立類型執行個體，並叫用和存取它們。 </p>
</blockquote>
<p>我習慣將 Reflection 叫做反射，感覺這一篇在挖坑給自己跳，這邊只會介紹動態屬性存取與調用方法。</p>
<p>昨天提到了 Type 類型，這個類型有一個調用成員的方法 InvokeMember。</p>
<h4 id="InvokeMember"><a href="#InvokeMember" class="headerlink" title="InvokeMember"></a>InvokeMember</h4><p>InvokeMember(string name, BindingFlags invokeAttr, Binder binder, object target, object[] args)</p>
<p>一樣是多載方法，以下內容皆引用 Microsoft Docs 內容。</p>
<p><strong>name</strong>：字串，包含要叫用的建構函式、方法、屬性或欄位成員的名稱。</p>
<p><strong>invokeAttr</strong>：位元遮罩，由一或多個 BindingFlags 組成，而這些旗標會指定執行搜尋的方式。</p>
<p><strong>binder</strong>：定義一組屬性並啟用繫結的物件，可包含多載方法的選擇、引數類型的強制，以及透過反映的成員引動過程。</p>
<p><strong>target</strong>：要在其上叫用指定成員的物件。</p>
<p><strong>args</strong>：包含引數的陣列，這些引數會傳遞給要叫用的成員。</p>
<p>除了 binder 都是今天會用到的引數。</p>
<p>從上面描述來看，只有 invokeAttr 這個引數需要多做介紹，name 就成員名稱，target 就對象物件，args 就給對應成員的引數陣列。invokeAttr 其實就是一個 enum (DAY 14 提到的列舉)，透過當時講的 | 符號來疊加狀態，想了解狀態的欄位名稱與內容，就請自行前往參考連結囉。</p>
<p>在開始操作以前，我們需要使用<code>System.Reflection</code>命名空間。</p>
<p>這邊簡單的使用 BindingFlags.InvokeMethod、BindingFlags.SetProperty、BindingFlags.GetProperty 三種方法。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span> (<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> memberType = <span class="keyword">typeof</span> (Member);</span><br><span class="line">  <span class="keyword">var</span> member = <span class="keyword">new</span> Member () &#123; ID = <span class="number">1</span>, Name = <span class="string">"Miffy"</span> &#125;;</span><br><span class="line"></span><br><span class="line">  memberType.InvokeMember (<span class="string">"Print"</span>, BindingFlags.InvokeMethod, <span class="literal">null</span>, <span class="keyword">new</span> Member (), <span class="literal">null</span>);</span><br><span class="line">  memberType.InvokeMember (<span class="string">"Print"</span>, BindingFlags.InvokeMethod, <span class="literal">null</span>, member, <span class="literal">null</span>);</span><br><span class="line">  memberType.InvokeMember (<span class="string">"PrintWithMessage"</span>, BindingFlags.InvokeMethod, <span class="literal">null</span>, member, <span class="keyword">new</span> Object[] &#123; <span class="string">"s"</span> &#125;);</span><br><span class="line">  memberType.InvokeMember (<span class="string">"Name"</span>, BindingFlags.SetProperty, <span class="literal">null</span>, member, <span class="keyword">new</span> Object[] &#123; <span class="string">"Lulu"</span> &#125;);</span><br><span class="line">  <span class="keyword">var</span> memberName = memberType.InvokeMember (<span class="string">"Name"</span>, BindingFlags.GetProperty, <span class="literal">null</span>, member, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title">Member</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> ID &#123; <span class="keyword">set</span>; <span class="keyword">get</span>; &#125; = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">set</span>; <span class="keyword">get</span>; &#125; = <span class="string">"Mio"</span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Print</span> (<span class="params"></span>)</span> &#123; Console.WriteLine (<span class="string">$"ID = <span class="subst">&#123;ID&#125;</span>, Name = <span class="subst">&#123;Name&#125;</span>"</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrintWithMessage</span> (<span class="params"><span class="keyword">string</span> message</span>)</span> &#123; Console.WriteLine (<span class="string">$"ID = <span class="subst">&#123;ID&#125;</span>, Name = <span class="subst">&#123;Name&#125;</span>, Message = <span class="subst">&#123;message&#125;</span>"</span>); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>個人是滿少的情況下會去使用，只有當屬性名稱為不具有意義但有排序性的情況下(如：Time1, Time2, Time3)，才會這樣動態存取，不然就是本人還沒有深到去碰觸這一塊，畢竟只是個菜鳥 QQ</p>
<p>在操作時也可以使用 GetProperties 傳回的 PropertyInfo 類型，並使用他的 GetValue 與 SetValue 方法如</p>
<h4 id="GetValue"><a href="#GetValue" class="headerlink" title="GetValue"></a>GetValue</h4><p>GetValue (object obj, object[] index);</p>
<blockquote>
<p>傳回指定的物件的屬性值，和索引屬性的選擇性索引值。</p>
</blockquote>
<p><strong>obj</strong>：其屬性值將被傳回的物件。</p>
<p><strong>index</strong>：索引屬性的選擇性索引值。 索引屬性的索引以零為起始。 非索引屬性的這個值應為 null。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> member = <span class="keyword">new</span> Member () &#123; ID = <span class="number">1</span>, Name = <span class="string">"Miffy"</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> memberType = <span class="keyword">typeof</span> (Member);</span><br><span class="line"><span class="keyword">var</span> memberProperties = memberType.GetProperties ();</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> property <span class="keyword">in</span> memberProperties) &#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="keyword">value</span> = property.GetValue (member, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SetValue"><a href="#SetValue" class="headerlink" title="SetValue"></a>SetValue</h4><p>SetValue (object obj, object value)</p>
<blockquote>
<p>使用索引屬性的選擇性索引值，設定指定的物件的屬性值。</p>
</blockquote>
<p><strong>obj</strong>：將設定其屬性值的物件。</p>
<p><strong>value</strong>：新的屬性值。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> member = <span class="keyword">new</span> Member () &#123; ID = <span class="number">1</span>, Name = <span class="string">"Miffy"</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> memberType = <span class="keyword">typeof</span> (Member);</span><br><span class="line"><span class="keyword">var</span> memberProperties = memberType.GetProperties ();</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> property <span class="keyword">in</span> memberProperties) &#123;</span><br><span class="line">  <span class="keyword">if</span> (property.Name == <span class="string">"Name"</span>)</span><br><span class="line">    property.SetValue (member, <span class="string">"NekoSan"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及 GetMethods 傳回的 MethodInfo 類型，使用 Invoke 方法如</p>
<h4 id="Invoke"><a href="#Invoke" class="headerlink" title="Invoke"></a>Invoke</h4><p>Invoke (object obj, object[] parameters)</p>
<p><strong>obj</strong>：要在其上叫用指定成員的物件。</p>
<p><strong>parameters</strong>：包含引數的陣列，這些引數會傳遞給要叫用的成員。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> member = <span class="keyword">new</span> Member () &#123; ID = <span class="number">1</span>, Name = <span class="string">"Miffy"</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> memberType = <span class="keyword">typeof</span> (Member);</span><br><span class="line"><span class="keyword">var</span> memberMethods = memberType.GetMethods ();</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> method <span class="keyword">in</span> memberMethods) &#123;</span><br><span class="line">  <span class="keyword">if</span> (method.Name == <span class="string">"Print"</span>)</span><br><span class="line">    method.Invoke (member, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="一些小結論"><a href="#一些小結論" class="headerlink" title="一些小結論"></a>一些小結論</h3><p>今天簡單的介紹了反射的使用，如何動態調用成員，在使用上，往往會把 name 的字串換成變數使用，藉由變數內容來對應成員名稱，做到程式編譯時期能夠想用啥方法就用啥方法，我也是因為這原因才接觸到反射的，所以更艱深的部分我就不曉得了。</p>
<p>感謝閱讀，今天的內容可能有誤，閱讀後請再三求證喔。</p>
<p>參考連結<br><a href="https://docs.microsoft.com/zh-tw/dotnet/framework/reflection-and-codedom/reflection" target="_blank" rel="noopener">.NET Framework 中的反映 | Microsoft Docs</a><br><a href="https://docs.microsoft.com/zh-tw/dotnet/framework/reflection-and-codedom/dynamically-loading-and-using-types" target="_blank" rel="noopener">動態載入和使用類型 | Microsoft Docs</a><br><a href="https://docs.microsoft.com/zh-tw/dotnet/api/system.type.invokemember" target="_blank" rel="noopener">Type.InvokeMember Method (System) | Microsoft Docs</a><br><a href="https://docs.microsoft.com/zh-tw/dotnet/api/system.reflection.bindingflags" target="_blank" rel="noopener">BindingFlags Enum (System.Reflection) | Microsoft Docs</a></p>
</div></div><div class="post-main post-comment"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'mio-blog';
var disqus_identifier = '2018/11/05/2018-11-05-learn-csharp-in-30-days-26/';
var disqus_title = '.NET 後端起手式 30天認識 C# - Day 26 反射';
var disqus_url = 'http://yoursite.com/2018/11/05/2018-11-05-learn-csharp-in-30-days-26/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" target="_blank" rel="noopener" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-156431110-1');ga('send','pageview');</script></body></html>