<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="你好，我是米歐，歡迎來到我的部落格:)"><meta property="og:title" content="MMiooiMM"><meta property="og:description" content="你好，我是米歐，歡迎來到我的部落格:)"><meta property="og:image" content="https://raw.githubusercontent.com/MMiooiMM/MMiooiMM.github.io/master/images/VeryImportantFile.jpg"><title>C# using declaration 語法糖的甜蜜陷阱 | MMiooiMM</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="/css/mio.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 4.2.1"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/NET/" rel="tag">.NET</a><a class="post-tag-link" href="/tags/CSharp/" rel="tag">CSharp</a></div><div class="post-time">2023-10-23</div></div></div><div class="container post-header"><h1>C# using declaration 語法糖的甜蜜陷阱</h1></div><div class="container post-content"><p>如果你跟我一樣，習慣性的優先使用 “using declaration” 來撰寫 <code>using</code> 語句，並且翻寫範例時會自動將 “using statement” 轉換成 “using declaration”，那麼不久的將來你可能也會遇到這個問題。</p>
<h2 id="using-declaration"><a href="#using-declaration" class="headerlink" title="using declaration"></a>using declaration</h2><p>在 C# 8 更新中推出了 <a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-8.0/using" target="_blank" rel="noopener">using declaration</a>，它是對 <code>using</code> 語句的簡化和擴展。使用 “using declaration” 有以下幾個好處：</p>
<ol>
<li><p><strong>程式碼簡潔性：</strong>讓程式碼更簡潔，省去了 <code>using</code> 語句的需求，使程式碼看起來更整潔，特別是當有多個 <code>using</code> 語句時。例如，對比傳統的 <code>using</code> 語句 “using statement”：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> stream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 使用 stream</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>與 “using declaration”：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> stream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line"><span class="comment">// 使用 stream</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>範圍性：</strong>只在當前的範圍中有效。在範圍結束時，相應的資源會被自動關閉和釋放，不需要額外的 <code>Dispose()</code> 調用。關閉的順序如下，從最後一個到第一個：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">var</span> f1 = <span class="keyword">new</span> FileStream(<span class="string">"..."</span>);</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">var</span> f2 = <span class="keyword">new</span> FileStream(<span class="string">"..."</span>), f3 = <span class="keyword">new</span> FileStream(<span class="string">"..."</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Dispose f3</span></span><br><span class="line">    <span class="comment">// Dispose f2</span></span><br><span class="line">    <span class="comment">// Dispose f1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>可讀性：</strong>提高了程式碼的可讀性，使開發者更容易識別出哪些變數是具有限定範圍的。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> stream = <span class="keyword">new</span> MemoryStream();</span><br></pre></td></tr></table></figure>

<p>與</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stream = <span class="keyword">new</span> MemoryStream();</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>總而言之，”using declaration” 提供了一種更簡潔、可讀性更高的方式來處理需要釋放的資源，同時還具有範圍性，有助於減少資源泄漏的可能性，使程式碼更加安全可靠。</p>
<p>BUT!!! 會寫這篇文章就是因為我在使用 “using declaration” 時遇到了一個坑，讓我不得不重新思考使用 “using declaration” 的時機。如果你跟我一樣，習慣性的優先使用 “using declaration” 來撰寫 <code>using</code> 語句，並且翻寫範例時會自動將 “using statement” 轉換成 “using declaration”，那麼你可能也會遇到這個問題。</p>
<h2 id="錯誤案例"><a href="#錯誤案例" class="headerlink" title="錯誤案例"></a>錯誤案例</h2><p>這次我碰到的就是 Zip 操作時常用的類別 ZipArchive，以下是常見的 ZipArchive 使用方式：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] <span class="title">CompressFilesToZipWithUsingStatement</span>(<span class="params">Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">byte</span>[]&gt; filesToCompress</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> zipMemoryStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> zipArchive = <span class="keyword">new</span> ZipArchive(zipMemoryStream, ZipArchiveMode.Create))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> fileName <span class="keyword">in</span> filesToCompress.Keys)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> fileData = filesToCompress[fileName];</span><br><span class="line">                <span class="keyword">var</span> zipEntry = zipArchive.CreateEntry(fileName, CompressionLevel.Optimal);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">using</span> (<span class="keyword">var</span> entryStream = zipEntry.Open())</span><br><span class="line">                &#123;</span><br><span class="line">                    entryStream.Write(fileData, <span class="number">0</span>, fileData.Length);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> zipMemoryStream.ToArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但如果我們不經過大腦與測試將所有 “using statement” 改成 “using declaration”，就會發生一點問題：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] <span class="title">CompressFilesToZipWithUsingDeclaration</span>(<span class="params">Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">byte</span>[]&gt; filesToCompress</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">var</span> zipMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">var</span> zipArchive = <span class="keyword">new</span> ZipArchive(zipMemoryStream, ZipArchiveMode.Create);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> fileName <span class="keyword">in</span> filesToCompress.Keys)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> fileData = filesToCompress[fileName];</span><br><span class="line">        <span class="keyword">var</span> zipEntry = zipArchive.CreateEntry(fileName, CompressionLevel.Optimal);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">var</span> entryStream = zipEntry.Open();</span><br><span class="line">        entryStream.Write(fileData, <span class="number">0</span>, fileData.Length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> zipMemoryStream.ToArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是使用範例：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> filesToCompress = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">byte</span>[]&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta"><span class="meta-string">"mio.txt"</span></span>] = Encoding.UTF8.GetBytes(<span class="string">"Mio"</span>),</span><br><span class="line">    [<span class="meta"><span class="meta-string">"miffy.txt"</span></span>] = Encoding.UTF8.GetBytes(<span class="string">"Miffy"</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> zipFileStatement = CompressFilesToZipWithUsingStatement(filesToCompress);</span><br><span class="line"><span class="keyword">var</span> zipFileDeclaration = CompressFilesToZipWithUsingDeclaration(filesToCompress);</span><br><span class="line"></span><br><span class="line">File.WriteAllBytes(<span class="string">"using-statement.zip"</span>, zipFileStatement);</span><br><span class="line">File.WriteAllBytes(<span class="string">"using-declaration.zip"</span>, zipFileDeclaration);</span><br><span class="line">Console.WriteLine(<span class="string">"壓縮完成！"</span>);</span><br></pre></td></tr></table></figure>

<p>如果執行上面的程式碼，你會發現 “using declaration” 後產生的壓縮檔案是壞的，而 “using statement” 產生的壓縮檔案是正確的。</p>
<p><img src="/images/2023-10-23/zip-compresses-corrupted.jpg" alt="/images/2023-10-23/zip-compresses-corrupted.jpg"></p>
<h2 id="釋放資源的時機"><a href="#釋放資源的時機" class="headerlink" title="釋放資源的時機"></a>釋放資源的時機</h2><p>不是所有類別在釋放資源時，只是單純地釋放資源，也可能會進行額外的操作。</p>
<p>讓我們來看看 ZipArchive 在 <code>Dispose</code> 時會發生什麼事情：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="keyword">bool</span> disposing</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (disposing &amp;&amp; !_isDisposed)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">switch</span> (_mode)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> ZipArchiveMode.Read:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ZipArchiveMode.Create:</span><br><span class="line">                <span class="keyword">case</span> ZipArchiveMode.Update:</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    Debug.Assert(_mode == ZipArchiveMode.Update || _mode == ZipArchiveMode.Create);</span><br><span class="line">                    WriteFile();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            CloseStreams();</span><br><span class="line">            _isDisposed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到當 ZipArchiveMode 為 Create 或 Update 時，會呼叫 <code>WriteFile</code> 方法：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">WriteFile</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="comment">// ... 省略部分程式碼</span></span><br><span class="line"></span><br><span class="line">    WriteArchiveEpilogue(startOfCentralDirectory, sizeOfCentralDirectory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這邊我們只需要關注在最後一個方法 <code>WriteArchiveEpilogue</code>：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// writes eocd, and if needed, zip 64 eocd, zip64 eocd locator</span></span><br><span class="line"><span class="comment">// should only throw an exception in extremely exceptional cases because it is called from dispose</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">WriteArchiveEpilogue</span>(<span class="params"><span class="keyword">long</span> startOfCentralDirectory, <span class="keyword">long</span> sizeOfCentralDirectory</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ... 省略部分程式碼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看方法說明可以知道是用於寫入壓縮檔案的結尾，那這個與壓縮檔錯誤有什麼關係呢？回頭看原先的語法：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] <span class="title">CompressFilesToZipWithUsingDeclaration</span>(<span class="params">Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">byte</span>[]&gt; filesToCompress</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">var</span> zipMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">var</span> zipArchive = <span class="keyword">new</span> ZipArchive(zipMemoryStream, ZipArchiveMode.Create);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> fileName <span class="keyword">in</span> filesToCompress.Keys)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> fileData = filesToCompress[fileName];</span><br><span class="line">        <span class="keyword">var</span> zipEntry = zipArchive.CreateEntry(fileName, CompressionLevel.Optimal);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">var</span> entryStream = zipEntry.Open();</span><br><span class="line">        entryStream.Write(fileData, <span class="number">0</span>, fileData.Length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> zipMemoryStream.ToArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>還記得 “using declaration” 的資源釋放時機是區塊的結束，也就是說在 <code>return zipMemoryStream.ToArray();</code> 結束離開區塊後。所以在 <code>zipArchive</code> 釋放資源之前，也就是寫入壓縮檔的結尾之前，就已經將 <code>zipMemoryStream</code> 轉換成 byte[] 並回傳了，所以壓縮檔案當然會壞掉！</p>
<h2 id="心法"><a href="#心法" class="headerlink" title="心法"></a>心法</h2><p>除非明確了解類別的 <code>Dispose</code> 行為，否則 IDE 提示你簡化時你在簡化，可以看到圖片中只有 <code>MemoryStream</code> 與 <code>zipEntry.Open()</code>(Stream) 兩個類型時會有修正通知，這是由於 Visual Studio 分析器(<a href="https://learn.microsoft.com/en-us/visualstudio/code-quality/roslyn-analyzers-overview?view=vs-2022" target="_blank" rel="noopener">Overview of source code analysis</a>)判斷出這兩個類型在 <code>Dispose</code> 時只是單純地釋放資源，不會有額外的操作，所以可以安全地轉換成 “using declaration”。</p>
<p><img src="/images/2023-10-23/IDE0063.png" alt="/images/2023-10-23/IDE0063.png"></p>
</div></div><div class="post-main post-comment"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'mio-blog';
var disqus_identifier = '2023/10/23/2023-10-23-using-statement-vs-using-declaration/';
var disqus_title = 'C# using declaration 語法糖的甜蜜陷阱';
var disqus_url = 'http://yoursite.com/2023/10/23/2023-10-23-using-statement-vs-using-declaration/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" target="_blank" rel="noopener" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-156431110-1');ga('send','pageview');</script></body></html>